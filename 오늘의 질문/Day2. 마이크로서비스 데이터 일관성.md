# 마이크로서비스 데이터 일관성

### 마이크로서비스 혹은 분산 시스템에서 데이터 일관성을 유지하기 위한 전략을 고민하거나 적용한 경험이 있다면 공유해주세요. 규모가 작아도 서비스 간 데이터 처리 흐름을 설계해본 경험이면 충분합니다.
힌트보기: 단일 DB 트랜잭션이 아닌, 서비스 간 데이터 일관성을 유지하는 방식을 고민해본 경험을 떠올려 보세요. (예: Eventual Consistency, 이벤트 기반 처리, SAGA 패턴 등)
<br/> <br/> 

### 🎯 경험 공유: 결제 서비스 도입을 고민하며 고려했던 데이터 일관성 전략

결제 서비스 도입을 고민하면서, **서비스 간 데이터 일관성**을 어떻게 유지할 수 있을지에 대해 집중적으로 설계하고 여러 시나리오를 작성해보았습니다. 마이크로서비스 간 데이터 흐름에 대해 실질적인 고민을 했던 경험입니다.

### 1. 고민 배경
- 기존 예약 서비스 외에, 결제 서비스를 별도로 분리하려는 기획이 있었습니다.
- 예약이 생성되면 자동으로 결제가 이루어져야 하며, 결제 성공 여부에 따라 예약 상태가 변경되어야 하는 구조였습니다.
- 각 서비스는 독립적인 데이터베이스를 사용하기 때문에, 단일 트랜잭션만으로는 데이터 일관성을 보장하기 어렵다고 판단했습니다.

### 2. 주요 고민 포인트
1. **이벤트 기반 처리**  
   예약 생성 시 이벤트를 발행하고, 결제 서비스에서 이를 구독해 결제를 처리하는 구조가 적절하다고 판단했습니다. 이벤트 드리븐 아키텍처는 서비스 간의 결합도를 낮추는 데에도 유리하다고 보았습니다.

2. **최종적 일관성 모델**  
   실시간으로 트랜잭션을 묶는 대신, 시간이 다소 걸리더라도 결국 상태가 일관되도록 처리하는 접근 방식(최종적 일관성)을 염두에 두었습니다.

3. **SAGA 패턴 적용 가능성**  
   결제 실패 시 예약을 취소하거나 다른 보상 작업이 필요한 시나리오가 있었기 때문에, 보상 트랜잭션 중심의 **SAGA 패턴**(Choreography 방식)을 적용할 수 있을지 고민했습니다.

4. **실패 처리 및 재시도**  
   이벤트 누락, 네트워크 오류 등 예외 상황을 고려해, 메시지 브로커의 재시도 메커니즘이나 **DLQ(Dead Letter Queue)** 설계도 함께 검토했습니다.

### 3. 배운 점
- 데이터 일관성 유지를 위해 고민하다 보니, 단순히 기능을 나누는 것보다 **전체 비즈니스 흐름에서 데이터가 어떻게 흘러야 하는지를 먼저 고려해야 한다**는 점을 배웠습니다.
- 특히 마이크로서비스 환경에서는 기술적 트랜잭션 처리보다 **비즈니스 로직 기반의 보상 전략과 일관성 모델 설계**가 훨씬 중요하다는 것을 체감했습니다.
<br/>

---

## 🌱 마이크로서비스 데이터 일관성

마이크로서비스 아키텍처(MSA)에서는 각 서비스가 독립적으로 배포되고 실행되며, 일반적으로 각 서비스는 자체 데이터베이스를 갖는다. 이로 인해 데이터 일관성(Data Consistency)이 중요한 이슈이다.

### ⚠️ 마이크로서비스에서 데이터 일관성의 도전 과제
1. **분산된 데이터 저장소**: 각 서비스가 고립된 DB를 가지므로, 트랜잭션이 여러 DB에 걸쳐 있을 수 있다.
2. **ACID 트랜잭션의 한계**: 전통적인 RDBMS의 ACID 트랜잭션은 분산 환경에서는 적용이 어렵거나 비효율적이다.
3. **서비스 간 비동기 통신**: 이벤트 기반으로 서비스가 통신하면 타이밍 문제, 장애 처리, 재시도 로직 등이 복잡해진다.

### 🥕 데이터 일관성 유형
1. **강한 일관성 Strong Consistency**
    - 모든 노드에서 즉시 동일한 데이터를 볼 수 있다.
    - 단일 DB에서는 가능하나, MSA 환경에서는 어렵고 성능 저하를 초래할 수 있다.

2. **최종적 일관성 Eventual Consistency**
    - 데이터가 일시적으로 불일치할 수 있지만, 시간이 지나면 일관된 상태가 된다.
    - MSA에서는 일반적으로 이 접근을 채택한다.

3. **사용자 정의 일관성 Business Consistency / SAGA 패턴**
    - 비즈니스 규칙에 기반한 일관성 확보 방법이다.
    - 각 서비스가 로컬 트랜잭션을 유지하고 전체 프로세스는 사가 패턴 등으로 조정한다.

### 🧑🏻‍🌾 MSA에서 데이터 일관성을 유지하는 패턴
1. **SAGA 패턴**
    - 장기 실행 트랜잭션을 여러 로컬 트랜잭션으로 나누어 처리한다.
    - 실패 시 보상 트랜잭션(rollback 대신 compensating action)을 수행한다.
    - 구현 방식:
      - Choreography: 이벤트 기반. 각 서비스가 이벤트를 구독하고 실행
      - Orchestration: 중앙 조정자가 전체 흐름 관리
2. **이벤트 소싱 Event Sourcing**
    - 상태 변화 자체를 이벤트로 저장한다.
    - 최종 상태는 이벤트의 누적으로 구성된다.
    - 모든 변경 이력이 남아 있어 감사/복원이 가능하다.
3. **CQRS(Command Query Responsibility Segregation)**
    - 명령(Command)과 조회(Query)를 분리한다.
    - 쓰기 모델과 읽기 모델을 따로 관리하며, 데이터 복제/동기화로 최종 일관성을 확보한다.
  
### 👀 핵심 요약
1. 마이크로서비스 환경에서는 전통적인 강한 일관성을 포기하고, 최종적으로 보상 로직 기반의 비즈니스 일관성을 중심으로 설계하는 것이 현실적이다.
2. 시스템의 목적, 비즈니스 요구사항, 장애 허용성에 따라 적절한 일관성 모델과 패턴을 선택하는 것이 핵심이다.
